Progress Report 4
====================
  
1. A strong (A) data analysis will use at least two of the four algorithms (conditional means, regression, logistic regression, k-means clustering) that we discussed in class. The data analysis will include a measure of model fit and will describe which characeristics are closely related to the outcome. The analysis will include cross-validation, which will be correctly exectued and described. 

2. A strong (A) final project will include nicely labeled, easy to understand graphics that describe exactly what is happening with the patterns in the data. The graphics will be complex, showing lots of numbers. The response could include (but doesn't have to include) interactive graphics. 

3. A strong (A) final project will include a 1500-2000 word description that is easily understandable by an interested layperson. Assume that your audience is your boss-- not me. It will be much easier to write this if you have a perspective. 

A strong (A) paper will have code that can generate results from the raw data in an easy to understand way. The code will be commented and will run on my computer without me having to tweak it in any way. (Easy test is to knit the document, with all related files in same directory)

```{r  include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(plotly)
library(gridExtra)
library(ModelMetrics)
library(haven)
library(readxl)
library(forcats)
library(RColorBrewer)
library(rvest)
```

```{r data}
download.file("https://www.eia.gov/environment/emissions/state/excel/coal_CO2_by_state_2014.xlsx",destfile = "coal_co2.xlsx",method="curl")

coal_co2<-read_excel("coal_co2.xlsx")

## Create a rank variable for percent change (excluding unnecessary rows and all columns that aren't percent change)

coal_co2_slim<-coal_co2[-(c(1,2,11,54:58)),-(c(2:36))]
coal_co2_slim<-coal_co2_slim%>%mutate(percent_change_rank=rank(`X__36`))
#I'm confused because when I look at the ranks of percent change, they actually aren't correct... the state that should be last is LA (increased 112%) and the state that should be first is Vermont (decreased 1%)... what is happening? Also, wy does it seem like states barely changed at all in percent of emissions from 1980-2014? Is that right??

colnames(coal_co2_slim)<-c("state","percent_change_emissions","absolute_change_emissions","percent_change_rank")

#open csv file I created that has: abbreviation of state name, binary for co2 emission cap laws by state, and investment in renewable energy by state (in USD)
cap_laws<-read_csv(file="emission_caps.csv")

colnames(cap_laws)<-c("state","abbreviation","emission_cap","renewable_investment")
cap_laws<-cap_laws[-(c(1)), ]

coal_laws_total<-merge(cap_laws,coal_co2_slim,by="state")

coal_laws_total<-coal_laws_total%>%mutate(percent_change_emissions=as.numeric(percent_change_emissions)) #this is to recode the emissions variable so that it's numeric 


coal_laws_total$abbreviation<-as.factor(coal_laws_total$abbreviation) 

coal_laws_total$percent_change_rank<-as.factor(coal_laws_total$percent_change_rank) 

View(coal_laws_total)
```
##Goal: 
We are a state legislation group trying to decide what would be the most effective use of our funds in order to decrease the CO2 emissions in our state. To do so, we're measuring the impact that various legislation and investments have had on CO2 emissions across states.

#Data and Measurements:
The data in this report is gleaned from the US Energy Information Administration, the US Environmental Protection Agency, and the National Conference of State Legislation. All binary variables were coded based on the presence or absence of particular legislation enacted by state, as recorded in the National Conference of State Legislation.

#Univariate Graphic
Dependent Variable: CO2 Emissions by State
Graphic: Rank of State Percent Change in CO2 Emissions from 1980-2014
```{r univariate plot}
#doesn't have to be a new variable;  but just need it all reordered by percent change rank 1-50
#create a new variable that is my percent change rank of state in order (1 being the least increase (aka biggest decrease) in c02 emission and 50 being the biggest increase in emissions)
#what I want this to look like is the state abbreviations on the y axis (because of coord flip), all in order of percent change rank. Then on the x axis will be the numbers for percent change in co2 emission 
coal_laws_total<-coal_laws_total%>%mutate(state_sort=fct_reorder(f=abbreviation,x=percent_change_rank))

View(coal_laws_total)

coal_laws_total<-coal_laws_total%>%mutate(state_sort=fct_reorder(percent_change_rank),ties.method="random")


#this is the code for the plot, but it won't let me actually run the code because it says I have a non-numeric argument to the binary operator                                  
## Plot by rank
gg<-ggplot(data=coal_laws_total,aes(x=state_sort,y=percent_change_emissions))
gg<-gg +geom_bar()

##Add Axis Labels
gg<-gg+xlab("State by Rank of Change in CO2 Emissions")+ylab("CO2 Emissions Percent Change 1980-2014")

gg<-coord_flip()

#add breaks for the emissions data instead of having every numeral from all 50 states
gg<-gg+scale_y_continuous(breaks=c(-7,-6,-5,-4,-3,-2,-1,0,1,2,3,4,5,6,7,8))
## Add Points
gg<-gg+geom_point(alpha=1,size=.5)

gg
```
As the figure shows, Louisiana is ranked 50th in percent change of CO2 emissions from 1980-2014; it increased CO2 emissions by 112% during that time, making it an extreme outlier. On the other hand, Vermont is ranked 1st; it decreased CO2 emissions by 1% from 1980-2014. The median change in CO2 emission by state during this time was x.

#How does level of investment in renewable energy affect CO2 emission by state?
```{r}
##Condtional Average of percent change in co2 emissions based on 4 levels of investment in renewable energy by state
## Create a variable for quartiles of investment in renewable energy
coal_laws_total<-coal_laws_total%>%mutate(investment_level=ntile(renewable_investment,4))

table(coal_laws_total$investment_level)

coal_laws_total<-coal_laws_total%>%group_by(investment_level)%>% ## Group by predictor
  ##Calculate mean at each level of predictor
  mutate(pred_emission_investment=mean(percent_change_emissions))%>% 
  ## Ungroup
  ungroup()%>% 
  #Rank by prediction, with ties sorted randomly
  mutate(pred_emission_investment_rank=rank(pred_emission_investment,ties.method="random"))
```

```{r}
#scatterplot of conditional mean of investment rank
gg<-ggplot(data=coal_laws_total,aes(x=pred_emission_investment_rank,y=percent_change_emissions,color="Actual"))
gg<-gg+geom_point(alpha=.5,size=.5)
gg<-gg+geom_point(aes(x=pred_emission_investment_rank,y=pred_emission_investment,color="Predicted:Conditional Mean, 1 var"))
gg<-gg+theme(legend.position="bottom")
gg<-gg+xlab("Rank")+ylab("Percent Change CO2 Emissions")
gg
```


#How does the presence of a law capping CO2 emissions affect actual CO2 emissions?
```{r}
#could also have a conditional mean of emission cap versus no emission cap 

```

```{r}
#could do scatterplot of conditional mean of emission laws existing or not
```


#Predictive Model of CO2 Emissions
```{r}
#regression of percent change of emissions by state based on that state's investment in renewable energy and the existence of legal state-wide co2 emission caps
mod<-lm(percent_change_emissions~ 
           renewable_investment+ 
           emission_cap,
         data=coal_laws_total,na.action="na.exclude")
summary(mod)

#create a variable of the predictions of the regression
coal_laws_total<-coal_laws_total%>%mutate(pred=predict(mod))
```

```{r}

#scatterplot of percent change of emissions based on investment level, with whether or not emission laws exist as the color
g1<-ggplot(data=coal_laws_total, aes(x=investment_level,y=percent_change_emissions,color=emission_cap)+
           geom_point(shape=1)+ #specify points
           geom_smooth(method=lm)) #ask for lm line
g1


#scatterplot of actual percent change emissions versus predicted percent change emissions from the regression
g2<-ggplot(coal_laws_total, aes(x=percent_change_emissions,y=exp(pred))
+geom_point(shape=1))
g2
```

#Accuracy of the model
```{r}
#rmse of model

```

#Take-aways
how investment in renewable energy and emission cap laws and other laws affect emissions; recommendation could be about state government focusing on whatever type seems most effective

-----
need to figure out the non-numeric error message, the reordered variable in order of rank, build out the variables (help below), and see what else I can incorporate from lessons

cookbook for R graphics online can help with graphics
need to build out the variables a little moreo (fees collected, more types of laws etc)

can incorporate GDP change as a percentage over 1980-2014, population change as a percent from 1980-2014, fines collected for violation of emission laws by state, and existence of coal laws
-----need to do a cross-validation

